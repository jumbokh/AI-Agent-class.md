

---

## **實驗 2 流程圖指導說明**

### **流程圖解讀與教學重點**

**核心流程：載入金鑰 → 認證 → 讀取區塊 → 顯示內容**

**步驟 1：載入金鑰到讀卡器**
- **技術解析**：
  - APDU: `FF 82 00 00 06 FF FF FF FF FF FF`
  - 將 6 位元組金鑰載入到讀卡器的易失性記憶體（插槽 0）
- **教學重點**：
  - 為什麼要載入？為了避免金鑰在 USB 傳輸中反复暴露
  - 插槽概念：讀卡器可同時儲存多組金鑰（0x00-0x0F）
- **生物聯網安全啟發**：金鑰管理是物聯網安全的第一道防線

**步驟 2：進行區塊認證**
- **技術解析**：
  - APDU: `FF 86 00 00 05 01 00 04 60 00`
  - 參數解讀：`04`=區塊號, `60`=Key A, `00`=插槽 0
- **教學重點**：
  - 三次握手協議：讀卡器與卡片間的安全挑戰-應答
  - 認證的是**整個扇區**，不是單一區塊
- **類比說明**：就像先輸入密碼解鎖保險箱（扇區），才能存取裡面的抽屜（區塊）

**步驟 3：讀取區塊數據**
- **技術解析**：
  - APDU: `FF B0 00 04 10` 
  - `04`=區塊號, `10`=讀取 16 位元組
- **教學重點**：
  - MIFARE Classic 固定區塊大小：16 位元組
  - 成功狀態碼：`90 00`

**步驟 4：顯示區塊內容**
- **數據解析**：
  - 十六進位：原始數據查看，用於分析數據結構
  - ASCII：可讀文本查看，用於識別存儲的文本信息
- **教學提示**：混合顯示有助於理解數據的雙重意義

### **錯誤處理機制詳解**

**「載入金鑰失敗」**
- **可能原因**：
  - 金鑰長度不是 6 位元組
  - 讀卡器通訊異常
  - 插槽號碼無效
- **解決方案**：檢查金鑰陣列長度，重新插拔讀卡器

**「認證失敗」**
- **可能原因**：
  - 金鑰不正確（非 `FF FF FF FF FF FF`）
  - 區塊號錯誤（嘗試認證了無效區塊）
  - 卡片已更換或移出感應區
- **解決方案**：確認使用預設金鑰，檢查區塊號是否在 0-63 範圍內

**「讀取失敗」**
- **可能原因**：
  - 認證已過期（卡片移出後重新進入）
  - 區塊號無效
  - 通訊干擾
- **解決方案**：重新執行認證流程，確保卡片穩定放置

### **對應的 Python 程式碼解析**

```python
# 對應步驟 1：載入金鑰
LOAD_KEY = [0xFF, 0x82, 0x00, 0x00, 0x06] + KEY_A
data, sw1, sw2 = conn.transmit(LOAD_KEY)
if (sw1, sw2) != (0x90, 0x00):
    # 流程圖：錯誤結束：載入金鑰失敗
    raise Exception("載入金鑰失敗")

# 對應步驟 2：區塊認證  
AUTH_CMD = [0xFF, 0x86, 0x00, 0x00, 0x05, 0x01, 0x00, BLOCK, 0x60, 0x00]
data, sw1, sw2 = conn.transmit(AUTH_CMD)
if (sw1, sw2) != (0x90, 0x00):
    # 流程圖：錯誤結束：認證失敗
    raise Exception("認證失敗")

# 對應步驟 3：讀取區塊
READ_CMD = [0xFF, 0xB0, 0x00, BLOCK, 0x10]
data, sw1, sw2 = conn.transmit(READ_CMD)
if (sw1, sw2) != (0x90, 0x00):
    # 流程圖：錯誤訊息：讀取失敗
    print("讀取失敗")
else:
    # 對應步驟 4：顯示區塊內容
    hex_str = toHexString(data)
    ascii_str = bytes(data).decode('latin1', 'ignore')
    print(f"Hex: {hex_str} | ASCII: {ascii_str}")
```

### **記憶體結構教學**

**MIFARE Classic 1K 結構：**
```
扇區 0: Block 0-3   (Block 0=製造商資料，含UID)
扇區 1: Block 4-7   (Block 7=Sector Trailer)
扇區 2: Block 8-11
...
扇區 15: Block 60-63
```

**安全提醒：**
- **Block 0**：切勿寫入，包含卡片唯一識別信息
- **Sector Trailer**：每個扇區的最後一塊，包含金鑰和存取控制位元

### **生物聯網應用場景**

**實驗設備權限管理：**
- 不同扇區存儲不同設備的使用權限
- 技術人員卡片只能認證特定扇區
- 記錄設備使用次數和時間戳記

**學生實作任務：**
1. 成功讀取 Block 4、5、6 的數據
2. 比較不同區塊的內容差異
3. 記錄遇到的錯誤及解決方法

---

這個流程圖清晰地展示了**安全讀取**的關鍵三步驟。
