

---

## **實驗 3 流程圖指導說明**

### **流程圖解讀與教學重點**

**核心流程：讀取→解析→修改→寫回→驗證**

**步驟 B：載入金鑰並認證區塊**
- **技術延續**：沿用實驗 2 的認證機制
- **教學強調**：認證是**暫時性**的，卡片移出或超時後需要重新認證
- **生物聯網意義**：每次交易前都需要重新驗證身份，確保安全

**關鍵步驟：讀取區塊資料並解析 BAL 數值**
- **數據解析邏輯**：
  ```python
  # 從 16 位元組中解析 BAL=xxx 格式
  raw_data = bytes(data).decode('latin1', 'ignore').strip('\x00 ')
  if raw_data.startswith("BAL="):
      balance = int(raw_data.split("=")[1])
  ```
- **教學重點**：數據格式設計的重要性
- **錯誤處理**：如果格式不符，應有默認值或錯誤提示

**關鍵步驟：修改餘額與格式化寫入**
- **技術細節**：
  ```python
  # 格式化為固定長度 16 位元組
  new_balance = current_balance + 10
  data_string = f"BAL={new_balance}".ljust(16, ' ')
  write_data = list(data_string.encode('latin1'))
  ```
- **教學重點**：
  - `ljust(16, ' ')` 確保數據長度符合區塊大小
  - 填充空格而不是 null 字元，便於閱讀和調試

### **錯誤處理機制詳解**

**「認證失敗」**
- **可能原因**：
  - 卡片在操作過程中被移出感應區
  - 其他程式佔用了讀卡器資源
  - 讀卡器通訊不穩定
- **解決方案**：重新放置卡片，確保操作流程連續完成

**「寫入失敗」**
- **可能原因**：
  - 認證已過期（最常見）
  - 區塊被設定為唯讀（存取控制位元限制）
  - 數據長度不是 16 位元組
  - 硬體寫入保護
- **解決方案**：
  1. 重新執行認證流程
  2. 檢查數據長度是否正確
  3. 確認目標區塊是可寫入的數據塊

### **對應的 Python 程式碼解析**

```python
def wallet_operation():
    # 對應步驟 B：載入金鑰並認證
    conn = connect()
    auth(conn)  # 包含 LOAD_KEY + AUTHENTICATE
    
    # 對應：讀取並解析 BAL
    current_balance = read_balance(conn)
    print(f"當前餘額: {current_balance}")
    
    # 對應：修改餘額
    new_balance = current_balance + 10
    print(f"新的餘額: {new_balance}")
    
    # 對應：格式化並寫入
    write_balance(conn, new_balance)
    
    # 對應：重新讀取驗證
    verify_balance = read_balance(conn)
    print(f"驗證餘額: {verify_balance}")
    
    return verify_balance
```

### **數據完整性與安全教學**

**為什麼要「重新讀取並顯示新餘額」？**
- **驗證機制**：確認寫入操作確實成功
- **錯誤檢測**：及時發現寫入過程中的數據損壞
- **用戶反饋**：給用戶明確的操作結果確認

**數據格式設計的教學價值：**
```python
# 好的設計：易於解析
"BAL=100        "

# 不好的設計：難以解析
"\x00\x00\x64\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
```

### **生物聯網應用場景**

**實驗室設備使用計費系統：**
- 每張卡片存儲對應的「可用點數」
- 使用高級設備時自動扣款
- 管理員可以進行點數充值

**智能溫室資源管理：**
- 工作人員卡片存儲「工作時數」
- 不同區域訪問需要不同權限和計費
- 中央系統統計資源使用情況

### **學生實作挑戰**

**基礎任務：**
1. 成功實現餘額讀取、加值、寫回、驗證的完整流程
2. 處理各種錯誤情況（認證失敗、寫入失敗）

**進階挑戰：**
1. 實現「扣值」功能並處理餘額不足的情況
2. 添加交易記錄功能（使用其他區塊存儲歷史記錄）
3. 設計更安全的數據格式（包含校驗碼）

**除錯技巧：**
- 在每個步驟後顯示原始十六進位數據
- 使用 try-except 捕捉可能的異常
- 確認卡片始終保持在感應區內

---

這個流程圖很好地展示了**事務性操作**的完整生命周期。
